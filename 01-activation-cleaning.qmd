---
title: "Activations cleaning"
author: "Media Innovation Group"
---

::: callout-warning

## Things to check

I need to check some things with Lauren:

- Where is the original file from TDCJ with the activations data?
- Confirm what these dates are for.
- Are we interested in the exact time between initial temp and activation time?
- Are we interested in the _number of hours_ a unit is under protocol, or is the day suffient.

:::


## Overview

These are the days that a unit was under ICS protocols like providing extra ice water and access to cooler areas during extreme heat events. This data was acquired by Lauren McGaughy of The Texas Newsroom through a public information request to the Texas Department of Criminal Justice. 

## Possible update

**We don't have a complete record of where the activations CSV comes from.** Pretty sure this came from Lauren.

In our tracking Google sheet we do have the same data, except there are errors on the last line.

## Set up

You know the drill!

```{r}
#| label: setup
#| message: false

library(tidyverse)
library(janitor)
library(data.table)
```

## Comparison activation log

We'll check about the original CSV with Lauren, but in the meantime we'll compare that with the Activation records we also have in our tracking sheet. This copy was downloaded from our [MIG = TDCJ Basic Information](https://docs.google.com/spreadsheets/d/1vv81AaFwSzLl8lEDYHxI3ANkV2Gf08bh-i_LVDkseH8/edit?gid=1968960884#gid=1968960884) on the "Activation" tab. The Google Sheet has errors on the last record for 9/5/2023, but that record is in full in our csv log.

```{r}
#| label: download-activation-direct
#| eval: false

# download.file(
#   "https://docs.google.com/spreadsheets/d/e/2PACX-1vRebFs9O2i0HoygXTtIvuzdVTmyrjX3MeUorU9d4fpYkGX7Bb026OradFQ1MMk2ltcGnyILih6ow4F4/pub?gid=1968960884&single=true&output=csv",
#   "data-original/unit-activation-direct.csv"
#       )
```

Import direct log

```{r}
raw_activation_direct <- read_csv("data-original/unit-activation-direct.csv") |> 
  clean_names()

raw_activation_direct
```

This original files lacks on activation that is in our already-downloaded `unit-activation-log.csv`. We'll continue to use the -log version while we track down an original.

## Import activation log

Let's add our activation log file in. (This file was downloaded directly into the repo, but we lost track of the original file. It has an additional record or other copies don't have.)

```{r}
raw_activation_log <- read_csv("data-original/unit-activation-log.csv", skip = 1) |> 
  clean_names()

raw_activation_log
```

## Clean column names

Our column names didn't translate perfectly, so let's work on cleaning them up and remove the last two unnecessary columns.

```{r}
clean_activation_log <- raw_activation_log |> 
  select(
    initial_extreme_temp = initial_date_of_extreme_temperature,
    initiation_date = ics_implementation_date,
    county,
    unit = unit_affected,
    activation_date = date_5, 
    activation_time = time_6,
    deactivation_date = date_7,
    deactivation_time = time_8 
  )
```


## Change date columns

We need our dates to be date columns instead of character columns. Let's adjust.

```{r}
activation_log_dates <- clean_activation_log |> 
  mutate(
    initial_extreme_temp = mdy(initial_extreme_temp),
    initiation_date = mdy(initiation_date),
    activation_date = mdy(activation_date),
    deactivation_date = mdy(deactivation_date)
  ) 

activation_log_dates
```

## Document active days

In our data, a single row is an activation period with a start and end date. What we want is a row of data for each activated day ... so if it three days between the start and end date, we want a row for each of the three days, with a variable `activated` that includes that date.

We do this by creating a new "list column" that includes a sequence of dates starting at activation and ending at deactivation. We then unnest that list to create a row for each item in the list.

```{r}
unnested_actives <- activation_log_dates |> 
  mutate(activated = map2( #<1>
    activation_date, deactivation_date, #<2>
    ~seq(from = .x, to = .y, by = "day") #<3>
  )) |> 
  unnest(activated) #<4>

unnested_actives
```

1. We create a column called activated, and that will be filled with the result of the `map2()` function. What `map2()` allows us to do is take two variables from our data (our dates) and provide it to a function (`seq()`).
2. Here we list the two variables, our start and end dates.
3. This `seq()` function creates a list of dates in sequence by day, starting with our `activation_date` (.x) and ending with our `deactivation_date` (.y). The end result is a nested "list column" `activated` that holds all the dates. At this point we still have one row for each activation period.
4. Here the `unnest()` function creates a new copy of each row with one of the dates in our `activated` list column. So if an activation period was 4 days, here we end up for 4 rows of the same data except for the date in `activated`.

## Clean up our active dates

Here we simplify our activations to list so we can join it with other data. It results in just the unit, date and a `protocol_active` flag.

```{r}
clean_actives <- unnested_actives |> 
  select(c(unit, date = activated)) |> 
  mutate(protocol_active = T)

## showing one unit as example
clean_actives |> 
  filter(unit == "Jester III")
```

## Export

```{r}
clean_actives |> write_rds("data-processed/01-activation-cleaned.rds")
```




