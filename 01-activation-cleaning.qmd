---
title: "Activations cleaning"
author: "Media Innovation Group"
---

## Overview

It's time to add in a new data source: the heat protocol activation logs. This data was acquired by Lauren McGaughy of The Texas Newsroom through a public information request to the Texas Department of Criminal Justice. 

## Possible update

Could directly download and use [Activation Data](https://docs.google.com/spreadsheets/d/1vv81AaFwSzLl8lEDYHxI3ANkV2Gf08bh-i_LVDkseH8/edit?usp=sharing) from our MIG TDCJ Basic Information sheet, but it would force some reworking and it is missing one record for some reason.

## Set up

You know the drill!

```{r}
#| label: setup
#| message: false

library(tidyverse)
library(janitor)
library(data.table)
```

## Download activation log directly

This copy was downloaded from our [MIG = TDCJ Basic Information](https://docs.google.com/spreadsheets/d/1vv81AaFwSzLl8lEDYHxI3ANkV2Gf08bh-i_LVDkseH8/edit?usp=sharing) on the "Activation" tab.

It is missing a 9/5/2023 record that is in `unit-activation-log.csv`.

```{r}
#| label: download-activation-direct
#| eval: false

download.file(
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRebFs9O2i0HoygXTtIvuzdVTmyrjX3MeUorU9d4fpYkGX7Bb026OradFQ1MMk2ltcGnyILih6ow4F4/pub?gid=1968960884&single=true&output=csv",
  "data-raw/unit-activation-direct.csv"
      )
```
Import direct log

```{r}

raw_activation_direct <- read_csv("data-raw/unit-activation-direct.csv") |> 
  clean_names()

raw_activation_direct
```

This original files lacks on activation that is in our already-downloaded `unit-activation-log.csv`. We'll continue to use the -log version while we track down an original.

## Import activation log

Let's add our activation log file in. (This file was downloaded directly into the repo, but we lost track of the original file. It has an additional record or other copies don't have.)

```{r}
raw_activation_log <- read_csv("data-raw/unit-activation-log.csv", skip = 1) |> 
  clean_names()

raw_activation_log
```

## Clean column names

Our column names didn't translate perfectly, so let's work on cleaning them up and remove the last two unnecessary columns.

```{r}
clean_activation_log <- raw_activation_log |> 
  select(
    initial_extreme_temp = initial_date_of_extreme_temperature,
    initiation_date = ics_implementation_date,
    county,
    unit = unit_affected,
    activation_date = date_5, 
    activation_time = time_6,
    deactivation_date = date_7,
    deactivation_time = time_8 
  )
```


## Change date columns

We need our dates to be date columns instead of character columns. Let's adjust.

```{r}
activation_log_dates <- clean_activation_log |> 
  mutate(
    initial_extreme_temp = mdy(initial_extreme_temp),
    initiation_date = mdy(initiation_date),
    activation_date = mdy(activation_date),
    deactivation_date = mdy(deactivation_date)
  ) 

activation_log_dates
```

## Document active days

We need to turn our initial_extreme_temp column, implementation_date column and our deactivation_date column into date ranges.

```{r}
dirty_actives <- activation_log_dates |> 
  group_by(unit) |> 
  mutate(occurence = dense_rank(initial_extreme_temp)) |> 
  mutate(start = as.Date(activation_date), end = as.Date(deactivation_date)) |> 
  mutate(
    activated = map2(start, end, ~seq(from = .x, to = .y, by = "day"))
    ) |> 
  unnest(activated) 

dirty_actives
```

## Clean up our active dates

We need to create a status column, so let's remove everything other than unit and active dates.

```{r}
clean_actives <- dirty_actives |> 
  select(c(unit, activated)) |> 
  mutate(status = "active") |> 
  mutate(date = activated) |> 
  select(!activated)

clean_actives |> 
  filter(unit == "Byrd")
```

## Export

```{r}
clean_actives |> write_rds("data-processed/activation-log.rds")
```




