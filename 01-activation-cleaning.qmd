---
title: "activation-cleaning"
---

It's time to add in a new data source: the heat protocol activation logs. This data was acquired by Lauren McGaughy at KUT through a public information request to the Texas Department of Criminal Justice. 

## Set up

You know the drill!

```{r}
#| label: setup
#| message: false

library(tidyverse)
library(janitor)
library(data.table)
```

## Import activation log

Let's add our activation log file in.

```{r}
raw_activation_log <- read_csv("data-raw/unit-activation-log.csv")

raw_activation_log
```

## Clean column names

Our column names didn't translate perfectly, so let's work on cleaning them up and remove the last two unnecessary columns.

```{r}
activation_log <- raw_activation_log |> 
  rename(initial_extreme_temp = ...1) |> 
  rename(initiation_date = ...2) |> 
  rename(county = ...3) |> 
  rename(unit = ...4) |> 
  rename(activation_date = "ICS Initiated") |> 
  rename(activation_time = ...6) |> 
  rename(deactivation_date = "ICS Deactivated") |> 
  rename(deactivation_time = ...8) |> 
  select(!c(...9, ...10))

activation_log
```

Now let's remove the first row since that repeats our column information.

```{r}
clean_activation_log <- activation_log[-c(1), ]

clean_activation_log
```

## Change date columns

We need our dates to be date columns instead of character columns. Let's adjust.

```{r}
activation_log_dates <- clean_activation_log |> 
  mutate(
    initial_extreme_temp = mdy(initial_extreme_temp)
  ) |> 
  mutate(
    initiation_date = mdy(initiation_date)
    ) |> 
  mutate(
    activation_date = mdy(activation_date)
    ) |> 
  mutate(
    deactivation_date = mdy(deactivation_date)) 

activation_log_dates
```

## Document active days

We need to turn our initial_extreme_temp column, implementation_date column and our deactivation_date column into date ranges.

```{r}
dirty_actives <- activation_log_dates |> 
  group_by(unit) |> 
  mutate(occurence = dense_rank(initial_extreme_temp)) |> 
  mutate(start = as.Date(activation_date), end = as.Date(deactivation_date)) |> 
  mutate(
    activated = map2(start, end, ~seq(from = .x, to = .y, by = "day"))
    ) |> 
  unnest(activated) 

dirty_actives
```

## Clean up our active dates

We need to create a status column, so let's remove everything other than unit and active dates.

```{r}
clean_actives <- dirty_actives |> 
  select(c(unit, activated)) |> 
  mutate(status = "active") |> 
  mutate(date = activated) |> 
  select(!activated)

clean_actives |> 
  filter(unit == "Byrd")
```

## Export

```{r}
clean_actives |> write_rds("data-processed/activation-log.rds")
```




