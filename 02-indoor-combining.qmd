---
title: "Combine indoor logs"
---

## to do

> I've created station files that already have the protocol flags. This notebook could bring those in, but I'm not sure it is any more clear. I might trash those protocol data files.

## Overview

Here we bring together our indoor readings together with our station readings, and then create our protocol flags.

We'll compare two ways to handle the station data:

- Find the 3 p.m. hours to match when the prison is supposed to record their records.
- The daily summaries that have the hottest temp/heat index.

## Load our libraries

library(data.table)

```{r}
#| label: setup
#| message: false

library(tidyverse)
library(janitor)
```

## Downloading weather-logs files

We'll download a copy of our cleaned weather-logs into this repo so we don't have to rely on the original.

The station files come from the [weather-logs](https://github.com/utdata/weather-logs) repo. That repo is currently private, so we'll manually download the files into `data-processed/weather-logs`.

## Import our files

```{r}
#| label: imports

stations_daily <- read_rds("data-processed/weather-logs/01-station-daily-summary.rds")
stations_hourly <- read_rds("data-processed/weather-logs/01-station-hourly-readings.rds")
heat_warnings <- read_rds("data-processed/weather-logs/01-heat-warning-cleaned.rds")
activation <- read_rds("data-processed/01-activation-cleaned.rds")
indoor <-  read_rds("data-processed/01-indoor-cleaned.rds")
unit_info<- read_rds("data-processed/01-unit-info-cleaned.rds")
```

## Combine data files

Now that we've brought all of the files into our environment, it's time to put them all together!

The process we'll use is this:

- start with indoor readings
- join with unit-info to get the station ids
- join with the stations to get that information
- create our protocol flags
- export

First we'll combine our unit temperature logs with our activation status. We'll also take this time to fill in our inactives because our original file only denoted activation.

## Indoor + unit info

```{r}
indoor_unit <- indoor |> 
  left_join(unit_info, by = join_by(unit == unit_name)) |> 
  select(unit, date, unit_temp, nws_id, county) |> 
  arrange(unit, date)

# sample of data
indoor_unit |> slice_sample(n = 10)

# total row count
indoor_unit |> nrow()

# missing join count
indoor_unit |> filter(is.na(nws_id))

```

## Add stations

I did check and the daily summaries have more possible matches than pulling 3p-only values. Here we join by both the station id and date.

```{r}
indoor_stations <- indoor_unit |> 
  left_join(stations_daily, by = join_by(nws_id == station_id, date))

indoor_stations |> nrow()

indoor_stations |> head()
```

Unfortunately there are There are 1580 indoor records (out of 12323) without a matching station record.

```{r}
indoor_stations_peek <- indoor_stations |> 
  group_by(unit, nws_id) |>
  summarize(
    total_cnt = n(),
    na_cnt = sum(is.na(name))
  ) |> 
  ungroup() |> 
  adorn_totals("row") |> 
  tibble()

indoor_stations_peek
```

In some cases there are just missing days of readings, which could be for any number of reasons, like the observation station was down.

But there are a number of prison units where we could not find a NWS weather data within 40 miles. These fit into that category.

```{r}
indoor_stations_peek |> 
  filter(na_cnt > 0,
         total_cnt == na_cnt) |> 
  arrange(unit)
```

### Remove non-matches

We'll remove indoor records where we don't have a matching weather temperature since we can't do any comparison here. (May decide later we need this, but later code might have to change to deal with missing variables.)

```{r}
indoor_clipped <- indoor_stations |> 
  filter(!is.na(name))

indoor_clipped |> nrow()
```


## Create a flag

We know that one form of criteria for our heat protocol is if the feels like is greater than or equal to 113 for three days. Let's create a flag for days greater than or equal to 113 and then count the number of consecutive days.

```{r}
indoor_flags <- indoor_clipped |> 
  mutate(
    tmp_flag = (case_when(
      tmp_high >= 105 ~ TRUE,
      .default = FALSE)),
    hi_flag = (case_when(
      hi_high >= 113 ~ TRUE,
      .default = FALSE)),
    protocol_flag = case_when(
      tmp_flag == "TRUE" | hi_flag == "TRUE" ~ TRUE,
      .default = FALSE)
    )
  
indoor_flags
```

## Look for runs

Create if either are true column Add another column that showsd if true is along with active

```{r}
indoor_protocol <- indoor_flags |> 
  group_by(unit) |> 
  mutate(
    protocol_run = accumulate(protocol_flag, ~if_else(.y, .x + 1, 0))
  ) |> 
  mutate(
    protocol_met = case_when(
    protocol_run >= 3 ~ TRUE,
    .default = FALSE
  )) |> 
  ungroup()

indoor_protocol |> 
  select(unit, date, starts_with("protocol")) |> 
  # skipping lines to get to true values
  slice(80:100)
```


## Add activation days

Now we'll add a column that shows which prisons were actively under heat protocols.

```{r}
indoor_active <- indoor_protocol |> 
  left_join(activation) |> 
  mutate(protocol_active = if_else(is.na(protocol_active), F, T),
         protocol_fail = case_when(
           protocol_met == T & protocol_active == F ~ T,
           .default = F
         ))

indoor_active |> filter(protocol_met == T)
```

## Consider heat warnings

There are only six cases where we've found a heat warning in effect. This could be because we don't have a good match on these warnings unless it is set for the whole county.

We won't save this join since it is of little use.

```{r}
# add later
indoor_active |>
  left_join(heat_warnings, by = join_by(nws_id == station_code, date)) |> 
  filter(ehw_active == T)
  
```

## Export

We've put everything together! Now let's export it into data-processed.

```{r}
indoor_protocol |>
  write_rds("data-processed/02-indoor-combined.rds")
```

