---
title: "Indoor logs"
author: "Emily DeMotte & the Media Innovation Group"
format: html
code-fold: true
code-summary: "Click to show code"
---

We have recorded indoor temperatures for each unit April through September of 2022, 2023 and 2024 and April through July 25 (day the info request was filled) of 2025. According to the Texas Department of Criminal Justice, indoor temps are taken at 3pm every day from April through September at all units that do not have air conditioning. The data was acquired by Lauren McGaughy at KUT through a public information request to the Texas Department of Criminal Justice.

## Goals of this notebook

In this notebook, we will explore the following questions:

* What was the highest temperature reached each year, and where?  
* How many days was the indoor temperature at least X degrees (85, 90, 95, 100+) each year from 2022 to 2025.
* Which units consistently recorded the highest temperatures? 
* How many consecutive days in those measures? (Not tackled yet)

## Setup, import and preparation

```{r}
#| label: setup
#| message: false

# Loading our libraries
library(tidyverse)
library(janitor)
library(ggthemes)
library(DT)
library(ggwaffle)

# suppress group warning
options(dplyr.summarise.inform = FALSE)

# Reading in the cleaned and combined indoor logs.
indoor_logs_clean <- read_rds("data-processed/01-indoor-temps-all-cleaned.rds")

# Adding variables to help analysis by date.
indoor_logs <- indoor_logs_clean |> mutate(
  flo_mo = floor_date(date, unit = "month"),
  year = year(date)
) 
```

### Records per unit, year

Checking where we might have missing data ...

```{r}
indoor_logs |> 
  group_by(unit, year) |> 
  summarize(days_recorded = n()) |> 
  pivot_wider(names_from = year, values_from = days_recorded) |> 
  datatable()
```

Data takeaway: For 2022, 2023 and 2024, we have 183 total days of indoor temperature recordings. As of Oct. 17, 2025, we only have 122 days of 2025 recordings (April 1 through July 25) because we are waiting for the rest of the data to come in via a public information request.
For each year of data, there are 68 TDCJ units that recorded indoor temperatures. However, the units recorded differ by year, with 74 total units appearing across all four years of data. Sixty-three units appear in all four years of data. The 11 units that differ by year are as follows:

* Bartlett: 2025 only
* Baten: 2025 only
* Garza East: 2024 and 2025 only
* Gurney: 2025 only
* Johnston: 2022 and 2023 only
* Mountain View: 2022 and 2023 only
* O'Daniel: 2024 only (note: the Mountain View unit was renamed to Patrick O'Daniel in January 2024, which appears as O'Daniel in the data. They are the same unit.) 
* Plane: 2022, 2023 and 2024 only
* Sayle: appears in 2022 only 
* Segovia: 2023 (June, July and August and September only), 2024 and 2025 only 
* Young: 2022, 2023 and 2024 only

## Hottest temps each year

The top 10 hottest days indoors for each year.

```{r}
indoor_logs |> 
  group_by(year) |> 
  slice_max(temperature, n = 10) |> 
  select(year, unit, date, temperature)
```

Summarizing the times each unit appeared in the top 10 hottest temperature recordings each year. 

```{r}
indoor_logs |> 
  group_by(year) |> 
  slice_max(temperature, n = 10) |> 
  select(year, unit, date, temperature) |> 
  group_by(unit, year) |> 
  summarize(n = n()) |> 
  arrange(desc(n))
```

Data takeaway: For all complete years of data, the 10 hottest indoor temperatures recorded each year between April 1 and Sept. 30 across all units all exceeded 101 degrees.

```{r}
indoor_logs |> 
  group_by(year) |> 
  select(year, unit, date, temperature) |> 
  filter(temperature >= 100) |> 
  datatable()
```

Data takeaway: It reached 100 degrees indoors 210 times across all units between 2022 and 2025. Twice, it reached 105 or above. The hottest temperature was recorded at the Mountain View unit on June 19, 2023, which reached 106.8 degrees. The Mountain View unit was renamed to Patrick O'Daniel (appears as O'Daniel in the data) in January 2024 and houses female prisoners in Gatesville, Texas, about 45 miles west of Waco. 
 
## Temp ranges by month, year

This shows how many days per month a unit reached a specific indoor temperature.

```{r}
count_temps_unit_month <- indoor_logs|> 
  group_by(unit, flo_mo) |> 
  summarize(
    total_days = n(),
    cnt_85 = sum(temperature >= 85, na.rm = T),
    cnt_90 = sum(temperature >= 90, na.rm = T),
    cnt_95 = sum(temperature >= 95, na.rm = T),
    cnt_100 = sum(temperature >= 100, na.rm = T),
    cnt_105 = sum(temperature >= 105, na.rm = T),
    .groups = "drop"
  )

count_temps_unit_month |> datatable()
```

## Temp ranges by unit, year

Number of days unit reached a certain temperature within a year (which is really a 6-month period). Also the percentage of recorded days it was reached.

```{r}
count_temps_unit_year <- indoor_logs |> 
  group_by(unit, year) |> 
  summarize(
    total_days = n(),
    cnt_n85 = sum(temperature < 85, na.rm = T),
    cnt_85 = sum(temperature >= 85, na.rm = T),
    cnt_90 = sum(temperature >= 90, na.rm = T),
    cnt_95 = sum(temperature >= 95, na.rm = T),
    cnt_100 = sum(temperature >= 100, na.rm = T),
    .groups = "drop"
  ) |> mutate(
    pct_85 = cnt_85/total_days,
    pct_90 = cnt_90/total_days,
    pct_95 = cnt_95/total_days,
    pct_100 = cnt_100/total_days
  ) |> 
  mutate(across(starts_with("pct"), \(x) round(2))) # rounds percentage

count_temps_unit_year |> datatable()
```

## Temp ranges by year

How many "prison days" it reached a certain temperature each year. "Prison days" include all days recorded across all units each year.

```{r}
count_temps_year <- indoor_logs|> 
  group_by(year) |> 
  summarize(
    total_days = n(),
    cnt_85 = sum(temperature >= 85, na.rm = T),
    cnt_90 = sum(temperature >= 90, na.rm = T),
    cnt_95 = sum(temperature >= 95, na.rm = T),
    cnt_100 = sum(temperature >= 100, na.rm = T)
  ) |> mutate(
    pct_85 = cnt_85/total_days,
    pct_90 = cnt_90/total_days,
    pct_95 = cnt_95/total_days,
    pct_100 = cnt_100/total_days
  )  |> 
  mutate(across(starts_with("pct"), round, 2)) # rounds percentage

count_temps_year  
```

Data takeaways:

- Across all prisons in the data in from 2022-2024, it reached 85 degrees at least half the time between April 1 and Sept. 30.
- It reached 90 degrees at least a quarter of the time. (Doesn't include 2025 since we don't have full data.)
- It reached 100 degrees inside prisons more than 100 times in 2023 alone. Across all prisons, 37% of days between April and September reached 90 degrees. 

## 85 degree threshold

### Count units reaching 85 at least once

Starting with the 85 threshold data above, we find total units, then subtract a count units that didn't reach 85.

```{r}
count_temps_unit_year |>
  group_by(year) |>   
  summarise(
    total_units = n(),
    units_met_85 = total_units - sum(cnt_85 == 0),
  )
```


Let's find that unit in 2022 that didn't reach 85 degrees. These are the lowest of the "highest temperature for each unit" where we can see Sayle didn't reach 85 degrees twice. We only have 2022 data for the Sayle unit.

```{r}
indoor_logs |> 
  filter(year == 2022) |>
  group_by(unit) |> 
  slice_max(temperature) |> # find highest temp each unit
  arrange(temperature) |> # find lowest of those
  select(unit, date, temperature) |> 
  filter(temperature <= 90) # cutting here to show the next units for comparison
```

Takeaway: Every unit hit 85 degrees at least once every year with one exception in 2022, where the Sayle unit recorded 84.6 degrees as its highest temperature on two separate days. The Sayle unit was not included in the data for 2023, 2024 or 2025. 

### Units reaching 85 half the time

This counts the number of units that reached 85 degrees for half of the days measured. We also calculate for 75% of the days measured.

```{r}
count_temps_unit_year |>
  group_by(year) |>
  select(year, total_days, cnt_85, pct_85) |> arrange(desc(cnt_85)) |> 
  summarize(
    total_units = n(),
    cnt_half_85 = sum(pct_85 >= .50),
    cnt_34ths_85 = sum(pct_85 >= .75)
  )

```

Data takeaways:

- In 2022, 53 of 68 units reached 85 degrees or above on at least half of the days measured. In 2023, it was 54 of 68, and in 2024, it was 48 of 68. 
- Twelve units reached 85 degrees on 75% of days measured in 2022. In 2023, it was 10 units, and in 2024, it was eight units. 

### Units most at 85

This shows units each year with the most days to reach 85.

```{r}
count_temps_unit_year |> 
  group_by(year) |> 
  slice_max(pct_85, n = 3) |> # n argument adjust number per year
  select(unit, year, total_days, cnt_85, pct_85)
```

Data takeaway:

- In the Segovia unit in 2023, 94% of recorded days between June and September, or 115 days, reached 85 degrees. No data was recorded for April and May. The Segovia unit is located in South Texas outside of Edinburgh, about 20 miles north of McAllen. 
- Garza West reached 85 degrees on at least 80% of days between April and September each year since 2022. In 2022, 92% of days reached 85 degrees or above. Every year, Garza West was among the top three units with the highest percentage of days that reached at or above 85 degrees.

### Minimum days 85 threshold met

Here we find the fewest number of days it reached the 85-degree threshold within each year. We remove the Sayle unit that didn't ever reach 85 in 2022.

```{r}
count_temps_unit_year |>
  filter(cnt_85 > 0) |> # removes Sayle in 2022
  group_by(year) |> 
  slice_min(cnt_85, n = 1) |> 
  select(unit, year, total_days, cnt_85, pct_85)
```

Data takeaways:

- With the exception of the Sayle unit, it reached 85 degrees inside every unit for at least 43 days between April 1 and Sept. 30 in 2022. 
- In 2023, every unit saw at least 40 days reaching 85 degrees.
- Even in the relatively cool 2024 summer, it reached 85 degrees inside every unit for at least 27 days. 

## 90 degree threshold

### Units reaching 90 at least once

```{r}
count_temps_unit_year |>
  group_by(year) |>   
  summarise(
    total_units = n(),
    units_met_90 = total_units - sum(cnt_90 == 0),
  )
```

Data takeaway: Almost every unit also reached 90 degrees inside at least once each year, all but three units in 2022 and one in 2023.

### Units that hit 90° half the time

This counts the number of units that reached 90 degrees for half of the days measured. We also calculate for 75% of the days measured.

```{r}
count_temps_unit_year |>
  group_by(year) |>
  select(year, total_days, cnt_90, pct_90) |> arrange(desc(cnt_90)) |> 
  summarize(
    total_units = n(),
    cnt_half_90 = sum(pct_90 >= .50),
    cnt_34th_90 = sum(pct_90 >= .75)
  )
```

Let's find those units that reach 90 for 75% of the time.

```{r}
count_temps_unit_year |> 
  # filter(year == 2023) |> 
  select(unit, year, total_days, cnt_90, pct_90) |> 
  filter(pct_90 >= .75) |> 
  arrange(year)
```

Data takeaways: 

- In 2023, 19 of 68 units reached 90 degrees at least half of the days measured. This was also true for nine units in 2022 and six units in 2024. 
- Across all years of data, two units reached 90 degrees for at least 75% of days measured, Segovia in 2023 and Garza West in 2024.
-Segovia has fewer days measured in 2023, but it still reached 90 degrees more than 100 times. In 2024, Garza West reached 90 degrees 137 times, or 75% of days between April 1 and Sept. 30. 


### Units with most days at 90

This shows units with the most days to reach 95 within each year.

```{r}
units_at_90 <- count_temps_unit_year |> 
  group_by(year) |> 
  slice_max(pct_90, n = 3) |> # n argument adjust number per year
  select(unit, year, total_days, cnt_90, pct_90)

units_at_90

units_at_90 |> filter(unit == "Garza West")
```

Data takeaway: In the Garza West unit, the temperature reached at least 90 degrees at least three out of five days each year from 2022 to 2024. In 2023 and 2024, 73% and 75% of days reached 90 degrees, respectively.

## 95 threshold

### Units reaching 95 at least once

```{r}
count_temps_unit_year |>
  group_by(year) |>   
  summarise(
    total_units = n(),
    units_met_95 = total_units - sum(cnt_95 == 0),
  )
```

Takeaway: In each year from 2022 to 2024, at least 50 of 68 units reached 95 degrees inside at least once between April 1 and Sept. 30. In 2025, 20 units had already reached 95 degrees indoors by July 25. 

### Units that reach 95 quarter of time

Here we calculate the number of units that reach 95 degrees at least a quarter of recorded days each year. This is a lower percentage than other thresholds.

```{r}
count_temps_unit_year |>
  group_by(year) |> 
  summarize(
    total_units = n(),
    cnt_quarter_95 = sum(pct_95 >= .25)
  )
```

Data takeaway: In 2023, there were 13 units where it reached 95 degrees inside a quarter of the time, or one out of every four days between April and September. This was true for six units in 2022 and three units in 2024. 

### Units most at 95

This shows units with the most days to reach 95 within each year.

```{r}
units_at_95 <- count_temps_unit_year |> 
  group_by(year) |> 
  slice_max(pct_95, n = 1) |> # n argument adjust number per year
  select(unit, year, total_days, cnt_95, pct_95)

units_at_95
```

Data takeaway: At the Garza West unit in 2023 it reached 95 degrees indoors more than 100 times. In other words, nearly three out of every five days between April 1 and Sept. 30. reached 95 degrees indoors. 

## 100 threshold

### Units reaching 100

```{r}
count_temps_unit_year |>
  group_by(year) |>   
  summarise(
    total_units = n(),
    units_met_100 = total_units - sum(cnt_100 == 0),
  )
```

Data takeaways: Between 2022 and 2024, at least a dozen units each year reached 100 degrees inside at least once. In 2023, 18 units reached 100 degrees indoors at least once between April and September. 

  
### Plot units at 100

This attempts to _show_ how many units reached 100 degrees at least once in a given year.

Since we'll want to make this chart for several years, I'll make it into a function to reuse.

```{r}
prison_waffle <- function(.data, yr) {
  .data |> 
    select(unit, year, cnt_100) |> 
    mutate(r_100 = if_else(cnt_100 > 0, "At least 100°", "High below 100°")) |> 
    filter(year == yr) |>
    waffle_iron(aes_d(group = r_100)) |> 
    ggplot(aes(x, y, fill = group)) + 
    geom_waffle() +
    theme_waffle() +
    labs(
      title = paste("Number of units to reach 100 in", yr),
      x = "", y = "", fill = "High temp"
    )
  
  ggsave(paste0("figures/waffle_plot_", yr, ".png"))

}

count_temps_unit_year |> prison_waffle(2022)
count_temps_unit_year |> prison_waffle(2023)
count_temps_unit_year |> prison_waffle(2024)
```

::: {.panel-tabset}

#### 2022

![](figures/waffle_plot_2022.png) 

#### 2023

![](figures/waffle_plot_2023.png) 
 
#### 2024

![](figures/waffle_plot_2024.png) 

:::
 
### Units that hit 100 inside

How many times each year a unit hit 100 degrees inside.

```{r}
unit_days_100 <- count_temps_unit_year |> 
  filter(cnt_100 > 0) |> 
  select(unit, year, total_days, cnt_100, pct_100) |> 
  arrange(year, cnt_100 |> desc())

unit_days_100
```

Let's date that and peek at just Garza West

```{r}
unit_days_100 |> filter(unit == "Garza West")
```

Takeaway: Garza West reached 100 degrees inside on 46 days between April and September in 2023. In other words, 25%, or one in every four days, reached 100 degrees. 

## Plot thresholds by year

Here we'll attempt to plot how many days a unit reached a certain temperature within a given year. We need to recalculate our thresholds.

Here we bin the number of days at certain temperatures, which is different than we we've been doing previously (which was total days at/above a temp).

```{r}
temp_thrsh_unit_year <- indoor_logs |> 
  group_by(unit, year) |> 
  summarize(
    cnt_n85 = sum(temperature < 85, na.rm = T),
    cnt_85 = sum(temperature >= 85 & temperature < 90, na.rm = T),
    cnt_90 = sum(temperature >= 90 & temperature < 95, na.rm = T),
    cnt_95 = sum(temperature >= 95 & temperature < 100, na.rm = T),
    cnt_100 = sum(temperature >= 100, na.rm = T),
    .groups = "drop"
  )

temp_thrsh_unit_year
```

To plot this we have to reshape the data, then plot as a bar chart. We save the chart before displaying it so we can control the size since there are so many units to show.

The plotting has been turned into a function to keep it dRy.

```{r}
# pivoting the data
thresh_data <- temp_thrsh_unit_year |> 
  pivot_longer(
    cols = starts_with("cnt"),
    names_to = "threshold",
    values_to = "days"
  ) |> 
  mutate(threshold = fct_inorder(threshold))

# plot the data into an object and then save that object into the figures folder.
plot_thresh_data <- function(yr) {
  thresh_plot <- thresh_data |> 
  filter(year == yr) |> 
  ggplot(aes(x = days, y = fct_rev(unit), fill = threshold)) +
  geom_bar(stat = "identity", position = position_stack(reverse = TRUE)) +
  scale_fill_brewer(
    palette='OrRd',
    labels = c(
      cnt_n85  = "Under 85°",
      cnt_85   = "85° to 89°",
      cnt_90   = "90° to 94°",
      cnt_95   = "95° to 99°",
      cnt_100  = "100° or more"
    )) +
  # theme(legend.position = "bottom") +
  labs(
    title = paste("Tracking indoor heat in prisons,", yr),
    x = "Number of days at each temperature", y = "",
    fill = "Indoor high"
  )
  
  ggsave(paste0("figures/thresh_plot_", yr, ".png"), width = 6, height = 12)

}

plot_thresh_data(2022)
plot_thresh_data(2023)
plot_thresh_data(2024)
plot_thresh_data(2025)

```


::: {.panel-tabset}

### 2022

![](figures/thresh_plot_2022.png) 

### 2023

![](figures/thresh_plot_2023.png)
 
### 2024

![](figures/thresh_plot_2024.png)
 
### 2025

![](figures/thresh_plot_2025.png)

:::

 