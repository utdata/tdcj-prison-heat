---
title: "data-combining"
---

We've cleaned up all of our relevant data files! Now we need to add them all together into one file for our analysis.

## Load our libraries

```{r}
#| label: setup
#| message: false

library(tidyverse)
library(janitor)
library(purrr)
library(dplyr)
library(data.table)
```

## Import data files

We need to read in our cleaned station, unit, unit info and activation files.

```{r}
stations <- read_rds("data-processed/station-all.rds")

stations
```

```{r}
units <- read_rds("data-processed/01-heat-all.rds")

units
```

```{r}
unit_info <- read_rds("data-processed/unit_info.rds")

unit_info
```

```{r}
activation <- read_rds("data-processed/activation-log.rds")

activation
```

## Combine data files

Now that we've brought all of the files into our environment, it's time to put them all together!

First we'll combine our unit temperature logs with our activation status. We'll also take this time to fill in our inactives because our original file only denoted activation.

```{r}
joined_file_1 <- units |> 
  left_join(activation, by = c("unit", "date")) |>   
  mutate(
    status = case_when(
      status == "active" ~ "active",
            .default = "inactive")
    )

joined_file_1
```

Now let's add in our unit information.

```{r}
joined_file_2 <- combo_file_1 |> 
  left_join(unit_info, by = "unit") 

joined_file_2
```

Lastly, we'll add in our station data.

```{r}
complete_join <- joined_file_2 |> 
  left_join(stations, by = c("station_code", "date")) |> 
  mutate(
  temp_diff = abs(station_temp - unit_temp)
)

complete_join
```

## Add in the feels like column

Now that we have all of our data together. Let's add in our feels like column and the temperature category.

```{r}
all_combined <- complete_join |> 
  mutate(
    feels_like = 
      - 42.379 + (2.04901523 * station_temp) + (10.14333127 * rh) 
      - (0.22475541 * station_temp * rh) - (6.83783 * 10^(-3) * station_temp^2) 
      - (5.481717 * 10^(-2) * rh^2) + (1.22874 * 10^(-3) * station_temp^2 * rh) 
      + (8.5282 * 10^(-4) * station_temp * rh^2) - (1.99 * 10^(-6) * station_temp^2 * rh^2)
  ) 

combined_final <- all_combined |> 
  mutate_if(is.numeric, ~round(., 2))|> 
  mutate(category = case_when
         (station_temp >= 80 & station_temp <= 88 & feels_like >= 80 & feels_like <= 90 ~"CAT 1",
          station_temp >= 89 & station_temp <= 96 & feels_like >= 91 & feels_like <= 103 ~"CAT 2",
          station_temp >= 97 & station_temp <= 106 & feels_like >= 103 & feels_like <= 124 ~"CAT 3",
          station_temp >= 107 & station_temp <= 110 & feels_like >= 125 & feels_like <= 137 ~"CAT 4",
          is.na(feels_like) ~ "NA",
          TRUE ~ "Normal")) |> 
  mutate(category = na_if(category, "NA")) |> 
  arrange(unit, date)

combined_final
```

## Export

We've put everything together! Now ket's export it into data-processed,

```{r}
combined_final |> 
  write_rds("data-processed/unit-station-data.rds")
```

