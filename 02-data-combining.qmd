---
title: "data-combining"
---

We've cleaned up all of our relevant data files! Now we need to add them all together into one file for our analysis.

## Load our libraries

```{r}
#| label: setup
#| message: false

library(tidyverse)
library(janitor)
library(data.table)
```

## Import data files

We need to read in our cleaned station, unit, unit info and activation files.

```{r}
stations <- read_rds("data-processed/station-all.rds")

stations
```

```{r}
units <- read_rds("data-processed/01-heat-all.rds")

units
```

```{r}
unit_info <- read_rds("data-processed/unit_info.rds")

unit_info
```

```{r}
activation <- read_rds("data-processed/activation-log.rds")

activation
```

## Combine data files

Now that we've brought all of the files into our environment, it's time to put them all together!

First we'll combine our unit temperature logs with our activation status. We'll also take this time to fill in our inactives because our original file only denoted activation.

```{r}
joined_file_1 <- units |> 
  left_join(activation, by = c("unit", "date")) |>   
  mutate(
    status = case_when(
      status == "active" ~ "active",
            .default = "inactive")
    )

joined_file_1
```

Now let's add in our unit information.

```{r}
joined_file_2 <- joined_file_1 |> 
  left_join(unit_info, by = "unit") 

joined_file_2
```

Lastly, we'll add in our station data.

```{r}
complete_join <- joined_file_2 |> 
  left_join(stations, by = c("station_code", "date")) |> 
  mutate(
  temp_diff = abs(station_temp - unit_temp)
)

complete_join
```

You'll notice that the station name, temperature, humidity and difference is missing for some days and units altogether. This is because there were either no recorded station temperatures in our time frame or there were no read-outs for the station. This was the case for the weather stations associated with Allred, San Saba, Henley, Hightower, Plane, Connally, Smith, Luther, Pack, Cole and Moore C.

## Add in the feels like column

Now that we have all of our data together. Let's add in our feels like column and the temperature category.

```{r}
all_combined <- complete_join |> 
  mutate(
    feels_like = 
      - 42.379 + (2.04901523 * station_temp) + (10.14333127 * rh) 
      - (0.22475541 * station_temp * rh) - (6.83783 * 10^(-3) * station_temp^2) 
      - (5.481717 * 10^(-2) * rh^2) + (1.22874 * 10^(-3) * station_temp^2 * rh) 
      + (8.5282 * 10^(-4) * station_temp * rh^2) - (1.99 * 10^(-6) * station_temp^2 * rh^2)
  ) 

combined_final <- all_combined |> 
  mutate_if(is.numeric, ~round(., 2))|> 
  mutate(category = case_when
         (station_temp >= 80 & station_temp <= 88 & feels_like >= 80 & feels_like <= 90 ~"CAT 1",
          station_temp >= 89 & station_temp <= 96 & feels_like >= 91 & feels_like <= 103 ~"CAT 2",
          station_temp >= 97 & station_temp <= 106 & feels_like >= 103 & feels_like <= 124 ~"CAT 3",
          station_temp >= 107 & station_temp <= 110 & feels_like >= 125 & feels_like <= 137 ~"CAT 4",
          is.na(feels_like) ~ "NA",
          TRUE ~ "Normal")) |> 
  mutate(category = na_if(category, "NA")) |> 
  arrange(unit, date)

combined_final
```

## Create a flag

We know that one form of criteria for our heat protocol is if the feels like is greater than or equal to 113 for three days. Let's create a flag for days greater than or equal to 113 and then count the number of consecutive days.

```{r}
consecutive_heat <- combined_final |> 
  mutate(index_flag = (case_when(
    feels_like >= 113 ~ TRUE,
    .default = FALSE
  ))) |> 
   mutate(temp_flag = (case_when(
    station_temp >= 105 ~ TRUE,
    .default = FALSE
  ))) 
  
consecutive_heat
```

Create if either are true column Add another column that showsd if true is along with active

```{r}
consecutive_heat |> 
  mutate(
  protocol_flag = case_when(
   temp_flag == "TRUE" | index_flag == "TRUE" ~ TRUE,
    .default = FALSE
  )) |> 
  mutate(
    run_protocol = accumulate(protocol_flag, ~if_else(.y, .x + 1, 0))
  ) |> 
  mutate(
    conditions_met = case_when(
    run_protocol >= 3 ~ TRUE,
    .default = FALSE
  )) |> 
  mutate(
    failure_to_launch = case_when(
      conditions_met == TRUE & status == "inactive" ~ "YES",
      .default = "NO"
    )
  ) |> 
  count(failure_to_launch == "YES")
```


## Export

We've put everything together! Now ket's export it into data-processed,

```{r}
combined_final |> 
  write_rds("data-processed/unit-station-data.rds")
```

